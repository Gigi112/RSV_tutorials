---
title: "Estimate RSV onset and peak timing"
subtitle: "Tutorial 2 for transition"
author: 
- Gigi (Zhe Zheng)^[zhe.zheng@yale.edu; zhe.zheng@aya.yale.edu; gigi.zhe.zheng@gmail.com]
- Dan (Daniel Weinberger) 
- Ginny (Virginia Pitzer)
date: "2023-01-04"
fontsize: 10pt
output: 
  beamer_presentation:
  theme: CambridgeUS
  colortheme: "beaver"
  fonttheme: "structurebold"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

## Background 

```{r figure1,echo = F,out.width = "100%", out.extra="page=4"}
knitr::include_graphics(path = "Epidemics_conference.pdf")
```

## Outline

- In section 1, we will first introduce how to find the peak timing of RSV epidemics using harmonic regression (given regular annual/biennial seasonality). We will then talk about identifying the onset of RSV epidemics using second derivative method, regardless of the seasonality of RSV.
\
\
- In section 2, we will learn how to use R to identify peak timing and onset of RSV epidemics.
\
\
- In section 3, we will incorporate the spatial component of RSV epidemics. We will first introduce the concept of spatial autocorrelation and then lean to use R to account for spatial autocorrelation.

## References

Relevant readings:
\
\
- [RSV onset timing at county level](https://doi.org/10.1093/cid/civ331)
\
\
- [RSV peak timing on state level](https://doi.org/10.1371/journal.ppat.1004591)
\
\
- [Comparing RSV onset timing before and during the COVID-19 pandemic](https://doi.org/10.1111/irv.12965)
\
\
- [RSV peak timing at ZIP code level and the drivers of RSV spread](https://doi.org/10.1126/sciadv.abd6421)

## Harmonic regression to estimate the peak timing of RSV epidemics

**Note: Most of the following materials came from Dan and Ginny's Lecture notes abd Harmonic Regression by NCSS^[https://www.ncss.com/wp-content/themes/ncss/pdf/Procedures/NCSS/Harmonic_Regression.pdf].**

Please check out:

-  Dan's class: Public Health Surveillance 
\
-  Ginny's class: Quantitative Methods in Infectious Diseases

$$X_t=\mu+R\cos(2\pi ft+d)+e_t$$
Where 
\
$X_t$ is the time-series contains a periodic (cyclic) component.
\
$\mu$ is mean of the series.
\
$R$ is the amplitude of seasonality.
\
$f=\frac{1}{period}$ is the frequency of the periodic.
\
$d$ is the phase or horizontal offset.
\
$e_t$ is the random error (noise) of the series.
\
$t$ is the time step

## Pseudo-RSV data: Simulate time series with a 12 month period
Imagine this is RSV case data from 2 states, and we want to investigate the epidemic characteristics in these states and the lag between states.

```{r simulate, echo=T}
set.seed(123)
n=120 # 10 years
t <- seq(1,n)
amp1=2.5 # high amplitude
freq=1/12 # frequency = 1/period
amp2=2 # low amplitude

xt1a=amp1*cos(2*3.14159*t*freq)

#other series shifted by 2 months
xt2a=amp2*cos(2*3.14159*t*freq+1)
 
#Simulate some poisson count data
xt1=rpois(n,exp((1+xt1a)))
xt2=rpois(n,exp(2+xt2a))
```

## The observed pseudo-RSV cases over time in two states

```{r, echo=F}
plot(t, xt1,type="l", lwd=3, xaxt="n",bty="l",
      ylab="Cases of RSV", xlab="Month(n)", 
      ylim=range(c(xt1,xt2)),
     xlim=c(0,max(t)+10))
lines(t,xt2,col="red")
axis(2, at = seq(0,120,20))
axis(1, at = seq(0,120,12))
text(x=max(t)+8, y=xt1[119], labels = "state1",col="black")
text(x=max(t)+8, y=xt2[119], labels = "state2",col="red")
```

## Investigate the epidemic characteristics of the pseudo-RSV time-serieses

This is based on the prior knowledge that RSV has annual cycle in temperate regions and biannual cycle in high latitude regions. For other viruses or RSV circulation in other climate, you should consider using wavelet analysis to identify the periodicity first.

```{r harm1, echo=TRUE}
# Create the needed harmonic variables with 
# 6 month, 12 month, and 24 month periodicities
t<-1:120
#Create harmonic variables
sin6=sin(2*pi*t/6)
cos6=cos(2*pi*t/6)
sin12=sin(2*pi*t/12)
cos12=cos(2*pi*t/12)
sin24=sin(2*pi*t/24)
cos24=cos(2*pi*t/24)
```

When you write the equations with sin and cos terms, you will need to include them both in an equation. For example, if the coefficient of cos12 is significant, you will need to include sin12 even though the coefficient is not significant in the summary.

## Fit a simple poisson regression with 12 month period for state 1

```{r harm_reg1}
fit1a <- glm(xt1~sin12+cos12, family='poisson')
pred1a<- fitted(fit1a)
#summary(fit1a)
```
```{r ,echo=FALSE}
plot (t, xt1,bty="l", xaxt="n",yaxt="n",col="blue",
      xlab="Month(n)",ylab="Cases of RSV", type="p",
      ylim=range(c(xt1,pred1a)),
     xlim=c(0,max(t)+25),main="State 1")
lines(t,pred1a, lty=1, lwd=3)
axis(2, at = seq(0,120,20))
axis(1, at = seq(0,120,12))
text(x=max(t)+15, y=pred1a[120], labels = "fitted",col="black")
text(x=max(t)+15, y=xt1[120], labels = "observed",col="blue")
```

## Add in 24 month periodicity

\scriptsize
```{r harm_reg2}
fit2a <- glm(xt1~sin12+cos12+sin24+cos24,family='poisson')
pred2a<- fitted(fit2a)
summary(fit2a)
```

## Add in 6 month periodicity

\tiny
```{r harm_reg3}
fit3a<-glm(xt1~sin12+cos12+sin24+cos24+sin6+cos6,family='poisson' )
pred3a<-fitted(fit3a)
summary(fit3a)
```

## Determine best model with AIC (smaller=better)
Winner is Model 1 (12 period). Also, when models have similar AIC score (within 2 points), we prefer a simpler model.
```{r aic}
 AIC(fit1a)
 AIC(fit2a)
 AIC(fit3a)
```

## Fit a simple poisson regression with 12 month period for state 2

```{r harm_reg4}
fit1b <- glm(xt2~sin12+cos12, family='poisson')
pred1b<- fitted(fit1b)
#summary(fit1a)
```

```{r, echo=FALSE}
plot (t,xt2,bty="l", xaxt="n",yaxt="n",col="blue",
      xlab="Month(n)",ylab="Cases of RSV", type="p",
      pch = 20,
      ylim=range(c(xt2,pred1b)),main="State 2")
lines(t,pred1b, lty=1, lwd=1,col="red")
axis(2, at = seq(0,120,20))
axis(1, at = seq(0,120,12))
```

## Calculate amplitudes of the 12 periods in state1 and state2
```{r amp}
beta_sin12_xt1<-coef(fit2a)['sin12']
beta_cos12_xt1<-coef(fit2a)['cos12']

amp12_xt1<-sqrt(beta_sin12_xt1^2+
                  beta_cos12_xt1^2)

amp12_xt1 #True value=2.5

beta_sin12_xt2<-coef(fit1b)['sin12']
beta_cos12_xt2<-coef(fit1b)['cos12']

amp12_xt2<-sqrt(beta_sin12_xt2^2+
                  beta_cos12_xt2^2)

amp12_xt2 #True value=2
```