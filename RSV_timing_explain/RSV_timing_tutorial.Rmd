---
title: "Estimate RSV onset and peak timing"
subtitle: "Tutorial 2 for transition"
author: 
- Gigi (Zhe Zheng)^[zhe.zheng@yale.edu; zhe.zheng@aya.yale.edu; gigi.zhe.zheng@gmail.com]
- Dan (Daniel Weinberger) 
- Ginny (Virginia Pitzer)
date: "2023-01-04"
fontsize: 10pt
output: 
  beamer_presentation:
  theme: CambridgeUS
  colortheme: "beaver"
  fonttheme: "structurebold"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

## Background 

```{r figure1,echo = F,out.width = "100%", out.extra="page=4"}
knitr::include_graphics(path = "Epidemics_conference.pdf")
```

## Outline

- In section 1, we will first introduce how to find the peak timing of RSV epidemics using harmonic regression (given regular annual/biennial seasonality). We will then talk about identifying the onset of RSV epidemics using second derivative method, regardless of the seasonality of RSV.
\
\
- In section 2, we will learn how to use R to identify peak timing and onset of RSV epidemics.
\
\
- In section 3, we will incorporate the spatial component of RSV epidemics. We will first introduce the concept of spatial autocorrelation and then lean to use R to account for spatial autocorrelation.

## References

Relevant readings:
\
\
- [RSV onset timing at county level](https://doi.org/10.1093/cid/civ331)
\
\
- [RSV peak timing on state level](https://doi.org/10.1371/journal.ppat.1004591)
\
\
- [Comparing RSV onset timing before and during the COVID-19 pandemic](https://doi.org/10.1111/irv.12965)
\
\
- [RSV peak timing at ZIP code level and the drivers of RSV spread](https://doi.org/10.1126/sciadv.abd6421)

## Harmonic regression to estimate the peak timing of RSV epidemics

**Note: Most of the following materials came from Dan and Ginny's Lecture notes abd Harmonic Regression by NCSS^[https://www.ncss.com/wp-content/themes/ncss/pdf/Procedures/NCSS/Harmonic_Regression.pdf].**

Please check out:

-  Dan's class: Public Health Surveillance 
\
-  Ginny's class: Quantitative Methods in Infectious Diseases

$$X_t=\mu+R\cos(2\pi ft+d)+e_t$$
Where 
\
$X_t$ is the time-series contains a periodic (cyclic) component.
\
$\mu$ is mean of the series.
\
$R$ is the amplitude of seasonality.
\
$f=\frac{1}{period}$ is the frequency of the periodic.
\
$d$ is the phase or horizontal offset.
\
$e_t$ is the random error (noise) of the series.
\
$t$ is the time step

## Pseudo-RSV data: Simulate time series with a 12 month period
Imagine this is RSV case data from 2 states, and we want to investigate the epidemic characteristics in these states and the lag between states.

```{r simulate, echo=T}
set.seed(123)
  n=120 # 10 years
  t <- seq(1,n)
 amp1=2.5 # high amplitude
 freq=1/12 # frequency = 1/period
 amp2=0.5 # low amplitude

 xt1a=amp1*cos(2*3.14159*t*freq)

#other series shifted by 2 months
 xt2a=amp1*cos(2*3.14159*t*freq+1)
 
#Simulate some poisson count data
 xt1=rpois(n,exp((1+xt1a)))
 xt2= rpois(n,exp(2+xt2a))
```

## The observed pseudo-RSV cases over time in two states

```{r, echo=T}
 plot(t, xt1,type="l", lwd=3, xaxt="n",bty="l",
      ylab="Cases of RSV", xlab="Month(n)", 
      ylim=range(c(xt1,xt2)))
 lines(t,xt2,col="red")
```
## Investigate the epidemic characteristics of the pseudo-RSV time-serieses

This is based on the prior knowledge that RSV has an annual cycle in temperate regions. For other viruses or RSV circulation in other climate, you should consider using wavelet analysis to identify the periodicity first.

### Create the needed harmonic variables with 12 month periods
```{r harm1, echo=TRUE}
t<-1:120
#Create harmonic variables
sin12=sin(2*pi*t/12)
cos12=cos(2*pi*t/12)
```

### Fit a simple poisson regression with 12 month period

